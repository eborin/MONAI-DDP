#+options: ':nil *:t -:t ::t <:t H:3 \n:nil ^:t arch:headline
#+options: author:t broken-links:nil c:nil creator:nil
#+options: d:(not "LOGBOOK") date:t e:t email:nil f:t inline:t num:nil
#+options: p:nil pri:nil prop:nil stat:t tags:t tasks:t tex:t
#+options: timestamp:t title:t toc:t todo:t |:t
#+date: 2019-09-27 sex
#+title: Graphics
#+author: Rafael Keller Tesser
#+email: rktesser@unicamp.br
#+language: en
#+tags: noexport(n) deprecated(d) ignore(i) RafaelTesser(R) EdsonBorin(E) OtatioNapoli(O) Daniel(D)
#+select_tags: export
#+exclude_tags: noexport
#+startup: overview indent
#+property: header-args:R :output-dir "./img" :session 202208-dl-cloud :datadir "./plots"
#+property: datadir "../logs"

* Pre-processing the data from the training logs

** Iteration times

The following code extracts the iteration times.

#+begin_src shell :results output :exports both
outfile="itertimes.csv"
echo exp  batch.size run start.date start.time iter.date iter.time epoch epoch.total iter iter.total > "$outfile"
for d in ../logs/*/;do
	 exp="$(basename $d)"

	 nexpbs1=0
	 nexpbs2=0
	 
	 for f in ${d}/*.log; do
	     #echo "$exp","$nexp"
	     #echo "$f"
	     start="$(grep "Engine run resuming" "$f" | cut -d " " -f -2)"
	     # All experiments finihed in the same day they started.
	     # So, we can ignore their dates when computing the timings

	     if grep -q 16/16 $f; then
		 bs=1;
		 nexpbs1=$((nexpbs1 + 1))
		 nexp=$nexpbs1
	     else
		 bs=2;
		 nexpbs2=$((nexpbs2 + 1))
		 nexp=$nexpbs2
	     fi
	     
	     egrep "Epoch.*Iter:" "$f" | sed -e "s/\(.*\) - ignite.engine.engine.DynUNetTrainer - INFO - Epoch: \([^\/]*\)\/\([^,]*\), Iter: \([^\/]*\)\/\([^ ]*\) .*/${exp} ${bs} ${nexp} ${start} \1 \2 \3 \4 \5/g" -e "s/,/\./g"
	     
	 done
done >> "$outfile"

## cat "$outfile"
head "$outfile"
#+end_src

#+RESULTS:
#+begin_example
exp batch.size run start.date start.time iter.date iter.time epoch epoch.total iter iter.total
IAAS-g3s.xlarge 1 1 2022-08-02 18:08:29.288 2022-08-02 18:11:39.198 1 10 1 16
IAAS-g3s.xlarge 1 1 2022-08-02 18:08:29.288 2022-08-02 18:11:41.943 1 10 2 16
IAAS-g3s.xlarge 1 1 2022-08-02 18:08:29.288 2022-08-02 18:11:44.553 1 10 3 16
IAAS-g3s.xlarge 1 1 2022-08-02 18:08:29.288 2022-08-02 18:11:47.166 1 10 4 16
IAAS-g3s.xlarge 1 1 2022-08-02 18:08:29.288 2022-08-02 18:11:49.845 1 10 5 16
IAAS-g3s.xlarge 1 1 2022-08-02 18:08:29.288 2022-08-02 18:11:52.464 1 10 6 16
IAAS-g3s.xlarge 1 1 2022-08-02 18:08:29.288 2022-08-02 18:11:55.089 1 10 7 16
IAAS-g3s.xlarge 1 1 2022-08-02 18:08:29.288 2022-08-02 18:11:57.702 1 10 8 16
IAAS-g3s.xlarge 1 1 2022-08-02 18:08:29.288 2022-08-02 18:12:00.409 1 10 9 16
#+end_example

** Epoch times

#+begin_src shell :results output :exports both
outfile="epochtimes.csv"
echo exp batch.size run epoch epoch.duration > "$outfile"
for d in ../logs/*/;do
	 exp="$(basename $d)"

	 nexpbs1=0
	 nexpbs2=0

	 for f in ${d}/*.log; do
	     #echo "$exp","$nexp"
	     #echo "$f"

	     if grep -q 16/16 $f; then
		 bs=1;
		 nexpbs1=$((nexpbs1 + 1))
		 nexp=$nexpbs1
	     else
		 bs=2;
		 nexpbs2=$((nexpbs2 + 1))
		 nexp=$nexpbs2
	     fi
	     
	     egrep "Epoch.*Complete" "$f" | cut -d " " -f 8- | sed -e "s/Epoch\[\(.*\)\] Complete. Time taken: \(.*\)/${exp} ${bs} ${nexp} \1 \2/g"
	     
	 done
done >> "$outfile"

## cat "$outfile"
head "$outfile"
#+end_src

#+RESULTS:
#+begin_example
exp batch.size run epoch epoch.duration
IAAS-g3s.xlarge 1 1 1 00:03:50
IAAS-g3s.xlarge 1 1 2 00:00:44
IAAS-g3s.xlarge 1 1 3 00:00:44
IAAS-g3s.xlarge 1 1 4 00:00:44
IAAS-g3s.xlarge 1 1 5 00:00:44
IAAS-g3s.xlarge 1 1 6 00:00:44
IAAS-g3s.xlarge 1 1 7 00:00:44
IAAS-g3s.xlarge 1 1 8 00:00:44
IAAS-g3s.xlarge 1 1 9 00:00:45
#+end_example


** Total training times

#+begin_src shell :results output :exports both
outfile="trainingtimes.csv"
echo exp batch.size run duration > "$outfile"
for d in ../logs/*/; do
	 exp="$(basename $d)"

	 nexpbs1=0
	 nexpbs2=0

	 for f in ${d}/*.log; do


	     if grep -q 16/16 $f; then
		 bs=1;
		 nexpbs1=$((nexpbs1 + 1))
		 nexp=$nexpbs1
	     else
		 bs=2;
		 nexpbs2=$((nexpbs2 + 1))
		 nexp=$nexpbs2
	     fi
	     
	     egrep "Engine run complete.*" "$f" | cut -d " " -f 13 | sed -e "s/\(.*\)/${exp} ${bs} ${nexp} \1/g"
	     
	 done
done >> "$outfile"
cat "$outfile"
#+end_src

#+RESULTS:
#+begin_example
exp batch.size run duration
IAAS-g3s.xlarge 1 1 00:10:29
IAAS-g3s.xlarge 1 2 00:09:39
IAAS-g3s.xlarge 1 3 00:09:34
IAAS-g4dn.xlarge 1 1 00:07:49
IAAS-g4dn.xlarge 1 2 00:07:28
IAAS-g4dn.xlarge 1 3 00:07:24
IAAS-g5.xlarge 1 1 00:03:27
IAAS-g5.xlarge 1 2 00:03:29
IAAS-g5.xlarge 1 3 00:03:29
IAAS-p2.xlarge 1 1 00:19:14
IAAS-p2.xlarge 1 2 00:19:14
IAAS-p2.xlarge 1 3 00:18:37
IAAS-p3.2xlarge 1 1 00:04:43
IAAS-p3.2xlarge 1 2 00:04:09
IAAS-p3.2xlarge 1 3 00:04:06
SAGEMAKER-ml-g4dn-xlarge 2 1 00:04:25
SAGEMAKER-ml-g4dn-xlarge 2 2 00:04:29
SAGEMAKER-ml-g4dn-xlarge 2 3 00:04:27
SAGEMAKER-ml-g4dn-xlarge 1 1 00:05:22
SAGEMAKER-ml-g4dn-xlarge 1 2 00:05:27
SAGEMAKER-ml-g4dn-xlarge 1 3 00:05:30
SAGEMAKER-ml-p3-2xlarge 2 1 00:01:50
SAGEMAKER-ml-p3-2xlarge 2 2 00:01:55
SAGEMAKER-ml-p3-2xlarge 2 3 00:01:51
SAGEMAKER-ml-p3-2xlarge 1 1 00:01:59
SAGEMAKER-ml-p3-2xlarge 1 2 00:01:57
SAGEMAKER-ml-p3-2xlarge 1 3 00:01:56
#+end_example


* Loading R packages

#+name: load-r-packages
#+begin_src R :results output :exports both :noweb no-export
suppressMessages(library(data.table))
suppressMessages(library(tidyverse))
options(crayon.enabled = FALSE)
options(dplyr.sumarise.inform = FALSE)
options(tidyverse.quiet = TRUE)
options(dplyr.summarise.inform = FALSE)
#+end_src

#+RESULTS: load-r-packages


* Reading the data into R

#+name: do-init
#+begin_src R :results output :exports both :noweb no-export
func.init <- function()
{
  <<load-r-packages>>
}

if(!exists("do.init")){
  do.init = TRUE
}

if(do.init == TRUE){
  func.init()
  do.init = FALSE
}
#+end_src

#+RESULTS: do-init

#+name: read-csv-data
#+begin_src R :results output :exports both :noweb no-export
## do.init=TRUE
<<do-init>>

read.timings.csv <- function(fn)
{
  read.table(fn, sep=" ", header=TRUE, stringsAsFactors=TRUE)
}
iter.dt   <- read.timings.csv("plots/itertimes.csv"    )
epoch.dt  <- read.timings.csv("plots/epochtimes.csv"   )
train.dt  <- read.timings.csv("plots/trainingtimes.csv")

## cat("Iterations:\n")
## head(iter.dt)
## cat("\nEpochs:\n")
## head(epoch.dt)
## cat("\nTraining:\n")
## head(train.dt)
#+end_src

#+RESULTS: read-csv-data
#+begin_example
Iterations:
              exp batch.size run start.date   start.time  iter.date
1 IAAS-g3s.xlarge          1   1 2022-08-02 18:08:29.288 2022-08-02
2 IAAS-g3s.xlarge          1   1 2022-08-02 18:08:29.288 2022-08-02
3 IAAS-g3s.xlarge          1   1 2022-08-02 18:08:29.288 2022-08-02
4 IAAS-g3s.xlarge          1   1 2022-08-02 18:08:29.288 2022-08-02
5 IAAS-g3s.xlarge          1   1 2022-08-02 18:08:29.288 2022-08-02
6 IAAS-g3s.xlarge          1   1 2022-08-02 18:08:29.288 2022-08-02
     iter.time epoch epoch.total iter iter.total
1 18:11:39.198     1          10    1         16
2 18:11:41.943     1          10    2         16
3 18:11:44.553     1          10    3         16
4 18:11:47.166     1          10    4         16
5 18:11:49.845     1          10    5         16
6 18:11:52.464     1          10    6         16

Epochs:
              exp batch.size run epoch epoch.duration
1 IAAS-g3s.xlarge          1   1     1       00:03:50
2 IAAS-g3s.xlarge          1   1     2       00:00:44
3 IAAS-g3s.xlarge          1   1     3       00:00:44
4 IAAS-g3s.xlarge          1   1     4       00:00:44
5 IAAS-g3s.xlarge          1   1     5       00:00:44
6 IAAS-g3s.xlarge          1   1     6       00:00:44

Training:
               exp batch.size run duration
1  IAAS-g3s.xlarge          1   1 00:10:29
2  IAAS-g3s.xlarge          1   2 00:09:39
3  IAAS-g3s.xlarge          1   3 00:09:34
4 IAAS-g4dn.xlarge          1   1 00:07:49
5 IAAS-g4dn.xlarge          1   2 00:07:28
6 IAAS-g4dn.xlarge          1   3 00:07:24
#+end_example

* Helper functions

I'll need to subtract timings in the format HH:MM:SS.mmm. For this purpose, I'll
implement functions to convert these timings to seconds or miliseconds, as shown
in the code block below.

#+name: fun-conv-timings
#+begin_src R :results output :exports both :noweb no-export
## t = "1:01:01.500"
my.tsec <- function(t.str)
{
t.spstr = unlist(strsplit(t.str, ":"))
t.spn = as.numeric(t.spstr)
t.sec = (t.spn[1] * 60 + t.spn[2]) * 60 + t.spn[3]
t.sec
}
my.tmsec <- function(t.str)
{
  my.tsec(t.str) * 1000
}

## secs = my.tsec(t)
## msecs = my.tmsec(t)

## secs
## msecs

#+end_src


* Plots

** Iteration times
*** Computing the duration of each iteration

As all training sessions finished in the same day as they started, it is safe to
ignore the dates in the log files.

Next, we will create columns for the converted timings from hour format to seconds,
the elapsed time at the end of each iteration, and their duration.

#+name: calc-iter-timings
#+begin_src R :results output :exports both :noweb no-export
<<fun-conv-timings>>

<<read-csv-data>>

exp.list <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

iter.dt %>%
  data.frame %>%
  filter(exp %in% exp.list) %>%
  mutate(start.sec = unlist(lapply(as.character(start.time), my.tsec)),
         iter.sec = unlist(lapply(as.character(iter.time), my.tsec)),
         iter.elapsed = iter.sec - start.sec) %>%
  group_by(exp, batch.size, run) %>%
  mutate(iter.dur = iter.elapsed - lag(iter.elapsed, default = 0)) %>%
  ungroup() %>% data.table -> iter.dt
  summary(iter.dt)
#+end_src

#+RESULTS: calc-iter-timings
#+begin_example
                       exp        batch.size         run         start.date  
 IAAS-g3s.xlarge         :  0   Min.   :1.000   Min.   :1   2022-07-26:  80  
 IAAS-g4dn.xlarge        :480   1st Qu.:1.000   1st Qu.:1   2022-07-27: 160  
 IAAS-g5.xlarge          :  0   Median :1.000   Median :2   2022-07-28: 240  
 IAAS-p2.xlarge          :480   Mean   :1.167   Mean   :2   2022-08-02:2400  
 IAAS-p3.2xlarge         :480   3rd Qu.:1.000   3rd Qu.:3                    
 SAGEMAKER-ml-g4dn-xlarge:720   Max.   :2.000   Max.   :3                    
 SAGEMAKER-ml-p3-2xlarge :720                                                
        start.time        iter.date           iter.time        epoch     
 10:47:41.187: 160   2022-07-26:  80   12:43:14.584:   2   Min.   : 1.0  
 10:47:41.204: 160   2022-07-27: 160   10:49:46.269:   1   1st Qu.: 3.0  
 10:47:41.206: 160   2022-07-28: 240   10:49:46.273:   1   Median : 5.5  
 11:25:52.599: 160   2022-08-02:2400   10:49:46.323:   1   Mean   : 5.5  
 11:30:12.898: 160                     10:49:48.091:   1   3rd Qu.: 8.0  
 12:01:57.830: 160                     10:49:48.200:   1   Max.   :10.0  
 (Other)     :1920                     (Other)     :2873                 
  epoch.total      iter          iter.total      start.sec        iter.sec    
 Min.   :10   Min.   : 1.000   Min.   : 8.00   Min.   :38861   Min.   :38986  
 1st Qu.:10   1st Qu.: 4.000   1st Qu.:16.00   1st Qu.:41413   1st Qu.:42183  
 Median :10   Median : 7.000   Median :16.00   Median :54135   Median :54263  
 Mean   :10   Mean   : 7.833   Mean   :14.67   Mean   :56119   Mean   :56365  
 3rd Qu.:10   3rd Qu.:12.000   3rd Qu.:16.00   3rd Qu.:70841   3rd Qu.:71088  
 Max.   :10   Max.   :16.000   Max.   :16.00   Max.   :75244   Max.   :75508  
                                                                              
  iter.elapsed         iter.dur      
 Min.   :   5.995   Min.   :  0.586  
 1st Qu.:  86.248   1st Qu.:  0.679  
 Median : 187.930   Median :  1.964  
 Mean   : 245.340   Mean   :  2.789  
 3rd Qu.: 286.957   3rd Qu.:  3.144  
 Max.   :1154.465   Max.   :188.090
#+end_example

#+begin_src R :results output :exports both :noweb no-export
write.csv(iter.dt, "iteration-times-processed.csv")
#+end_src

#+RESULTS:


*** Plots for BS=1

#+begin_src R :results output graphics file :file iteration-times.png :exports both :width 600 :height 600 :noweb no-export

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

plot.iter.times <- function(dt, scl="fixed")
{
  dt %>%
    ggplot(aes(x = iter, y = iter.dur, group = epoch, color=epoch)) +
    geom_line() +
    facet_grid(cols = vars(run), rows = vars(exp), scales=scl,
               labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Iteration number") +
    scale_y_continuous(name = "Iteration time (s)") +
    scale_color_discrete(name = "Epoch")
}

iter.dt %>%
  filter(batch.size == 1) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times() +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/iteration-times.png]]


Plot without the first iteration of the first epoch:

#+begin_src R :results output graphics file :file iteration-times-no-1st-iter.png :exports both :width 600 :height 600 :noweb no-export
iter.dt %>%
  filter(!(epoch == 1 & iter == 1)) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times() +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/iteration-times-no-1st-iter.png]]


Plot with free /y/ scale:

#+begin_src R :results output graphics file :file iteration-times-no-1st-iter-freescale.png :exports both :width 600 :height 600 :noweb no-export
iter.dt %>%
  filter(batch.size == 1) %>%
  filter(!(epoch == 1 & iter == 1)) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times(scl = "free_y") +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/iteration-times-no-1st-iter-freescale.png]]


Plotting only a few executions:
#+begin_src R :results output graphics file :file iteration-times-few-runs.png  :exports both :width 600 :height 400 :noweb no-export
plot.iter.times.v2 <- function(dt, scl = "fixed")
{
  dt %>%
    ggplot(aes(x = iter, y = iter.dur, group = epoch, color=epoch)) +
    geom_line() +
    facet_grid(cols = vars(exp), scales=scl,
               labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Iteration number") +
    scale_y_continuous(name = "Iteration time (s)") +
    scale_color_discrete(name = "Epoch")
}

# exps <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")
exps <- c("IAAS-g4dn.xlarge", "SAGEMAKER-ml-p3-2xlarge")

iter.dt %>%
  filter(batch.size == 1) %>%
  #filter(!(epoch == 1 & iter == 1) 1) %>%
  filter(run == 1 & exp %in% exps) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times.v2(scl = "free") +
  theme_bw() 
  
#+end_src

#+RESULTS:
[[file:./img/iteration-times-few-runs.png]]

Plotting only a few executions:
#+begin_src R :results output graphics file :file iteration-times-single-iaasg4dnxlarge.png  :exports both :width 600 :height 400 :noweb no-export
plot.iter.times.v3 <- function(dt, scl = "fixed")
{
  dt %>%
    ggplot(aes(x = iter, y = iter.dur, group = epoch, color=epoch)) +
    geom_line() +
    ## facet_grid(cols = vars(exp), scales=scl,
    ##            labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Iteration number") +
    scale_y_continuous(name = "Iteration time (s)") +
    scale_color_discrete(name = "Epoch")
}

# exps <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")
exps <- c("IAAS-g4dn.xlarge")

iter.dt %>%
  filter(batch.size == 1) %>%
  #filter(!(epoch == 1 & iter == 1) 1) %>%
  filter(run == 1 & exp %in% exps) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times.v3(scl = "free") +
  theme_bw() -> p1

iter.dt %>%
  filter(batch.size == 1) %>%
  filter(!(epoch == 1 & iter == 1)) %>%
  filter(run == 1 & exp %in% exps) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times.v3(scl = "free") +
  theme_bw() +
  theme(
    legend.position = "none"
    ) -> p2

p1 + annotation_custom(ggplotGrob(p2), xmin=3, xmax=16,
                       ymin = 10, ymax = 125)
#+end_src

#+RESULTS:
[[file:./img/iteration-times-single-iaasg4dnxlarge.png]]

#+begin_src R :results output graphics file :file iteration-times-single-sm-mlp3.2xlarge.png  :exports both :width 600 :height 400 :noweb no-export

# exps <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")
exps <- c("SAGEMAKER-ml-p3-2xlarge")

iter.dt %>%
  filter(batch.size == 1) %>%
  filter(run == 1 & exp %in% exps) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times.v3(scl = "free") +
  theme_bw() -> p1

iter.dt %>%
  filter(batch.size == 1) %>%
  filter(!(epoch == 1 & iter == 1)) %>%
  filter(run == 1 & exp %in% exps) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times.v3(scl = "free") +
  theme_bw() +
  theme(
    legend.position = "none"
    ) -> p2

p1 + annotation_custom(ggplotGrob(p2), xmin=3, xmax=16,
                       ymin = 1.5, ymax = 8.5)

#+end_src

#+RESULTS:
[[file:./img/iteration-times-single-sm-mlp3.2xlarge.png]]


*** Plots for BS=2

#+begin_src R :results output graphics file :file iteration-times-bs2.png :exports both :width 600 :height 400 :noweb no-export

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

plot.iter.times <- function(dt, scl="fixed")
{
  dt %>%
    ggplot(aes(x = iter, y = iter.dur, group = epoch, color=epoch)) +
    geom_line() +
    facet_grid(cols = vars(run), rows = vars(exp), scales=scl,
               labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Iteration number") +
    scale_y_continuous(name = "Iteration time (s)") +
    scale_color_discrete(name = "Epoch")
}

iter.dt %>%
  filter(batch.size == 2) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times() +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/iteration-times-bs2.png]]


Plot without the first iteration of the first epoch:

#+begin_src R :results output graphics file :file iteration-times-no-1st-iter-bs2.png :exports both :width 600 :height 400 :noweb no-export
iter.dt %>%
  filter(batch.size == 2) %>%
  filter(!(epoch == 1 & iter == 1)) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times() +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/iteration-times-no-1st-iter-bs2.png]]


Plot with free /y/ scale:

#+begin_src R :results output graphics file :file iteration-times-no-1st-iter-freescale-bs2.png :exports both :width 600 :height 400 :noweb no-export
iter.dt %>%
  filter(batch.size == 2) %>%
  filter(!(epoch == 1 & iter == 1)) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times(scl = "free_y") +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/iteration-times-no-1st-iter-freescale-bs2.png]]


Plotting only a few executions:
#+begin_src R :results output graphics file :file iteration-times-few-runs-bs2.png  :exports both :width 600 :height 400 :noweb no-export
plot.iter.times.v2 <- function(dt, scl = "fixed")
{
  dt %>%
    ggplot(aes(x = iter, y = iter.dur, group = epoch, color=epoch)) +
    geom_line() +
    facet_grid(cols = vars(exp), scales=scl,
               labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Iteration number") +
    scale_y_continuous(name = "Iteration time (s)") +
    scale_color_discrete(name = "Epoch")
}

# exps <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")
exps <- c("SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

iter.dt %>%
  filter(batch.size == 2) %>%
  #filter(!(epoch == 1 & iter == 1) 1) %>%
  filter(run == 1 & exp %in% exps) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times.v2(scl = "free") +
  theme_bw() 
  
#+end_src

#+RESULTS:
[[file:./img/iteration-times-few-runs-bs2.png]]

Plotting only a few executions:
#+begin_src R :results output graphics file :file iteration-times-single-sagemakermlg4dnxlarge-bs2.png  :exports both :width 600 :height 400 :noweb no-export
plot.iter.times.v3 <- function(dt, scl = "fixed")
{
  dt %>%
    ggplot(aes(x = iter, y = iter.dur, group = epoch, color=epoch)) +
    geom_line() +
    ## facet_grid(cols = vars(exp), scales=scl,
    ##            labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Iteration number") +
    scale_y_continuous(name = "Iteration time (s)") +
    scale_color_discrete(name = "Epoch")
}

# exps <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")
exps <- c("SAGEMAKER-ml-g4dn-xlarge")

iter.dt %>%
  filter(batch.size == 2) %>%
  #filter(!(epoch == 1 & iter == 1) 1) %>%
  filter(run == 1 & exp %in% exps) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times.v3(scl = "free") +
  theme_bw() -> p1

iter.dt %>%
  filter(batch.size == 2) %>%
  filter(!(epoch == 1 & iter == 1)) %>%
  filter(run == 1 & exp %in% exps) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times.v3(scl = "free") +
  theme_bw() +
  theme(
    legend.position = "none"
    ) -> p2

 p1 + annotation_custom(ggplotGrob(p2), xmin=2.5, xmax=8,
                       ymin = 4, ymax = 9.5)
#+end_src

#+RESULTS:
[[file:./img/iteration-times-single-sagemakermlg4dnxlarge-bs2.png]]

#+begin_src R :results output graphics file :file iteration-times-single-sagemager-mlp3.2xlarge-bs2.png  :exports both :width 600 :height 400 :noweb no-export

# exps <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")
exps <- c("SAGEMAKER-ml-p3-2xlarge")

iter.dt %>%
  filter(batch.size == 2) %>%
  #filter(!(epoch == 1 & iter == 1) 1) %>%
  filter(run == 1 & exp %in% exps) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times.v3(scl = "free") +
  theme_bw() -> p1

iter.dt %>%
  filter(batch.size == 2) %>%
  filter(!(epoch == 1 & iter == 1)) %>%
  filter(run == 1 & exp %in% exps) %>%
  mutate(epoch = factor(epoch)) %>%
  plot.iter.times.v3(scl = "free") +
  theme_bw() +
  theme(
    legend.position = "none"
    ) -> p2

p1 + annotation_custom(ggplotGrob(p2), xmin=2.5, xmax=8,
                       ymin = 1.5, ymax = 6)

#+end_src

#+RESULTS:
[[file:./img/iteration-times-single-sagemager-mlp3.2xlarge-bs2.png]]



*** Plots for BS1 with all instances

#+name: calc-iter-timings-all
#+begin_src R :results output :exports both :noweb no-export
<<fun-conv-timings>>
<<read-csv-data>>

exp.list <- c("IAAS-g4dn.xlarge", "IAAS-g3s.xlarge", "IAAS-g5.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\ng3s.xlarge", "IaaS\ng5.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-g3s.xlarge", "IAAS-g5.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

lbl.exp.1l <- c("IaaS g4dn.xlarge", "IaaS g3s.xlarge", "IaaS g5.xlarge", "IaaS p2.xlarge", "IaaS p3.2xlarge", "SageMaker ml.g4dn.xlarge", "SageMaker ml.p3.2xlarge")
names(lbl.exp.1l) <- c("IAAS-g4dn.xlarge", "IAAS-g3s.xlarge", "IAAS-g5.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

lbl.exp.1l.short <- c("g4dn.xlarge", "g3s.xlarge", "g5.xlarge", "p2.xlarge", "p3.2xlarge", "ml.g4dn.xlarge", "ml.p3.2xlarge")
names(lbl.exp.1l.short) <- c("IAAS-g4dn.xlarge", "IAAS-g3s.xlarge", "IAAS-g5.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")


iter.dt %>%
  data.frame %>%
  filter((exp %in% exp.list) & (batch.size == 1)) %>%
    mutate(start.sec = unlist(lapply(as.character(start.time), my.tsec)),
         iter.sec = unlist(lapply(as.character(iter.time), my.tsec)),
         iter.elapsed = iter.sec - start.sec) %>%
  group_by(exp, batch.size, run) %>%
  mutate(iter.dur = iter.elapsed - lag(iter.elapsed, default = 0)) %>%
  ungroup() %>% data.table -> iter.dt
  summary(iter.dt)
#+end_src

#+RESULTS: calc-iter-timings-all
#+begin_example
                       exp        batch.size      run         start.date  
 IAAS-g3s.xlarge         :480   Min.   :1    Min.   :1   2022-07-26:   0  
 IAAS-g4dn.xlarge        :480   1st Qu.:1    1st Qu.:1   2022-07-27:   0  
 IAAS-g5.xlarge          :480   Median :1    Median :2   2022-07-28:   0  
 IAAS-p2.xlarge          :480   Mean   :1    Mean   :2   2022-08-02:3360  
 IAAS-p3.2xlarge         :480   3rd Qu.:1    3rd Qu.:3                    
 SAGEMAKER-ml-g4dn-xlarge:480   Max.   :1    Max.   :3                    
 SAGEMAKER-ml-p3-2xlarge :480                                             
        start.time        iter.date           iter.time        epoch     
 10:47:41.187: 160   2022-07-26:   0   12:43:14.584:   2   Min.   : 1.0  
 10:47:41.204: 160   2022-07-27:   0   18:36:31.149:   2   1st Qu.: 3.0  
 10:47:41.206: 160   2022-07-28:   0   18:36:31.951:   2   Median : 5.5  
 11:25:52.599: 160   2022-08-02:3360   18:36:56.912:   2   Mean   : 5.5  
 11:30:12.898: 160                     18:37:39.705:   2   3rd Qu.: 8.0  
 12:01:57.830: 160                     10:49:46.269:   1   Max.   :10.0  
 (Other)     :2400                     (Other)     :3349                 
  epoch.total      iter         iter.total   start.sec        iter.sec    
 Min.   :10   Min.   : 1.00   Min.   :16   Min.   :38861   Min.   :38986  
 1st Qu.:10   1st Qu.: 4.75   1st Qu.:16   1st Qu.:43318   1st Qu.:43738  
 Median :10   Median : 8.50   Median :16   Median :65580   Median :65864  
 Mean   :10   Mean   : 8.50   Mean   :16   Mean   :57476   Mean   :57750  
 3rd Qu.:10   3rd Qu.:12.25   3rd Qu.:16   3rd Qu.:69212   3rd Qu.:69455  
 Max.   :10   Max.   :16.00   Max.   :16   Max.   :73955   Max.   :74071  
                                                                          
  iter.elapsed         iter.dur      
 Min.   :   5.995   Min.   :  0.388  
 1st Qu.: 144.168   1st Qu.:  0.668  
 Median : 205.117   Median :  1.963  
 Mean   : 273.867   Mean   :  2.769  
 3rd Qu.: 338.182   3rd Qu.:  2.671  
 Max.   :1154.465   Max.   :189.910
#+end_example

#+name: plot-iter-time-all
#+begin_src R :results output graphics file :file iteration-times-all-instances.png :exports both :width 600 :height 800 :noweb no-export

plot.iter.times <- function(dt, scl="fixed")
{
  dt %>%
    ggplot(aes(x = iter, y = iter.dur, group = epoch, color=epoch)) +
    geom_line() +
    facet_grid(cols = vars(run), rows = vars(exp), scales=scl,
               labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Step number", limits = c(1, NA)) +
    scale_y_continuous(name = "Step time (s)",
                       ## limits = c(0, 10), # this also removes the data points that are outside the limit
                       breaks = seq(2, 10, 2)) +
    ## ylim(0, 10) + # same as setting the limits in scale_y_continuous()
    coord_cartesian(ylim = c(0, 10)) + # this limits the axis but stil includes datapoints inside the limit
    scale_color_discrete(name = "Epoch") +
    theme_bw() +
    theme(
      text = element_text(size = 14, family = "serif")
    )
}

iter.dt %>%
  filter(batch.size == 1) %>%
  ## filter(epoch == 1) %>%
  ## filter(!(epoch == 1 & iter == 1)) %>%
  mutate(epoch = factor(epoch)) %>%
  ## plot.iter.times(scl = "fixed") +
  plot.iter.times(scl = "fixed") 
#+end_src

#+RESULTS: plot-iter-time-all
[[file:./img/iteration-times-all-instances.png]]

PDF version:
#+name: plot-iter-time-all-pdf
#+begin_src R :results output graphics file :file iteration-times-all-instances.pdf :exports both :width 6 :height 8 :noweb no-export

<<plot-iter-time-all>>

#+end_src

#+RESULTS: plot-iter-time-all-pdf
[[file:./img/iteration-times-all-instances.pdf]]


Using ~coord_cartesian()~ to set the /y/ axis limits disables the free scales in the facets, and  I could not find a way to set different ~coord_cartesian()~ limits for each facet. So, instead of using facets, I will create multiple plots and assemble them using the ~patchwork~ library.

#+name: plot-iter-time-all-v2
#+begin_src R :results output graphics file :file iteration-times-all-instances-v2.png :exports both :width 600 :height 800 :noweb no-export

library(patchwork)

calc.ymax <- function(dt, e)
{
  dt%>%
    filter(exp == e) %>%
    filter(!(epoch == 1 & iter == 1)) %>%
    data.frame() -> dt.tmp
  ceiling(max(dt.tmp$iter.dur))
  ## max(dt.tmp$iter.dur)
}

plot.single.run <- function(dt, e, r, ymax)
{
  if(ymax < 2)
    brkspc = 0.5
  else if(ymax < 5)
    brkspc = 1
  else
    brkspc = 2
    
  dt %>%
    ggplot(aes(x = iter, y = iter.dur, group = epoch, color=epoch)) +
    geom_line() +
    scale_x_continuous(name = "Step number",
                       limits = c(1, NA)) +
    scale_y_continuous(name = "Step time (s)",
                       ## limits = c(0, 10), # this also removes the data points that are outside the limit
                       breaks = seq(0, 10, brkspc)) +
    ## ylim(0, 10) + # same as setting the limits in scale_y_continuous()
    coord_cartesian(ylim = c(0, ymax)) + # this limits the axis but stil includes datapoints inside the limit
    scale_color_discrete(name = "Epoch") +
    ggtitle(paste0(e,", Run #", r)) +
    theme_bw() +
    theme(text = element_text(size = 14, family = "serif"),
          title = element_text(size = 12),
          axis.title = element_blank(),
          legend.title = element_text(size = 10),
          plot.margin = margin(1, 1, 1, 1, "pt")
          )
}

plot.iter.times.v2 <- function(dt)
{
  p = list()
  n = 1
  for(e in unique(iter.dt$exp)){
    ymax = calc.ymax(dt, e)
    for(r in unique(iter.dt$run)){
      dt %>%
        filter( run == r & exp == e) %>%
        plot.single.run(lbl.exp.1l.short[e], r, ymax) -> p[[n]]
      n = n + 1
    }
  }
  p
}

iter.dt %>%
  filter(batch.size == 1) %>%
  ## filter(epoch == 1) %>%
  ## filter(!(epoch == 1 & iter == 1)) %>%
  mutate(epoch = factor(epoch)) %>%
  ## plot.iter.times(scl = "fixed") +
  plot.iter.times.v2() -> p
yttl <- grid::textGrob('Step duration (s)', rot = 90)
xttl <- grid::textGrob('Step number')
pw <-
  (wrap_elements(yttl) + 
   (p[[ 1]] + p[[ 2]] + p[[ 3]] +
    p[[ 4]] + p[[ 5]] + p[[ 6]] +
    p[[ 7]] + p[[ 8]] + p[[ 9]] +
    p[[10]] + p[[11]] + p[[12]] +
    p[[13]] + p[[14]] + p[[15]] +
    p[[16]] + p[[17]] + p[[18]] +
    p[[19]] + p[[20]] + p[[21]] +
    plot_layout(guides="collect", ncol = 3, nrow = 7) &
    theme(legend.title = element_text(size = 12))) +
  plot_layout(ncol = 2 , nrow = 1, widths = c(0.1, 4))) /
  wrap_elements(xttl) +
  plot_layout(nrow = 2, heights = c(7, 0.125)) 
  
  
## wrap_elements(grid::textGrob('Step duration (s)', rot = 90)) | pw / grid::textGrob('Step number')

pw
#+end_src

#+RESULTS: plot-iter-time-all-v2
[[file:./img/iteration-times-all-instances-v2.png]]

PDF version:
#+name: plot-iter-time-all-v2-pdf
#+begin_src R :results output graphics file :file iteration-times-all-instances-v2.pdf :exports both :width 9 :height 12 :noweb no-export
<<plot-iter-time-all-v2>>
#+end_src

#+RESULTS: plot-iter-time-all-v2-pdf
[[file:./img/iteration-times-all-instances-v2.pdf]]


** Epoch times

*** Reading the data

#+name: read-epoch-times
#+begin_src R :results output :exports both :noweb no-export
<<fun-conv-timings>>

<<read-csv-data>>

exp.list <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

epoch.dt %>%
  data.frame %>%
  filter(exp %in% exp.list) %>%
  mutate(epoch.sec = unlist(lapply(as.character(epoch.duration), my.tsec))
           ) -> epoch.dt

glimpse(epoch.dt)
#+end_src

#+RESULTS: read-epoch-times
: Rows: 210
: Columns: 6
: $ exp            <fct> IAAS-g4dn.xlarge, IAAS-g4dn.xlarge, IAAS-g4dn.xlarge, I…
: $ batch.size     <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
: $ run            <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2…
: $ epoch          <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, …
: $ epoch.duration <fct> 00:02:34, 00:00:32, 00:00:34, 00:00:36, 00:00:36, 00:00…
: $ epoch.sec      <dbl> 154, 32, 34, 36, 36, 35, 36, 35, 36, 35, 153, 31, 32, 3…


*** Plots for BS=1

#+begin_src R :results output graphics file :file epoch-times.png :exports both :width 600 :height 400 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

plot.epoch.times <- function(dt, scl="fixed")
{
  dt %>%
    ggplot(aes(x = epoch, y = epoch.sec, group = run, color=run)) +
    geom_line() +
    ## facet_grid(cols = vars(exp), scales = scl,
    ##            labeller = labeller(exp = lbl.exp)) +
    facet_grid(rows = vars(exp), scales = scl,
               labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Epoch number", breaks = seq(0,10,1)) +
    scale_y_continuous(name = "Epoch time (s)", limits = c(0,NA)) +
    scale_color_discrete(name = "Run")
}

epoch.dt %>%
  filter(batch.size == 1) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times(scl = "fixed") +
  theme_bw()

#+end_src

#+RESULTS:
[[file:./img/epoch-times.png]]

#+begin_src R :results output graphics file :file epoch-times-free-scale.png :exports both :width 600 :height 400 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

epoch.dt %>%
  filter(batch.size == 1) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times(scl = "free") +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/epoch-times-free-scale.png]]

#+begin_src R :results output graphics file :file epoch-times-no-first-epoch.png :exports both :width 600 :height 400 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

epoch.dt %>%
  filter(batch.size == 1) %>%
  filter(epoch != 1) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times(scl = "fixed") +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/epoch-times-no-first-epoch.png]]

#+begin_src R :results output graphics file :file epoch-times-no-first-epoch-free-scale.png :exports both :width 600 :height 400 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")


epoch.dt %>%
  filter(batch.size == 1) %>%
  filter(epoch != 1) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times(scl = "free") +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/epoch-times-no-first-epoch-free-scale.png]]

**** With horizontal facets (one plot per column)

All epochs:

#+begin_src R :results output graphics file :file epoch-times-columns.png :exports both :width 600 :height 200 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

plot.epoch.times.cols <- function(dt, scl="fixed")
{
  dt %>%
    ggplot(aes(x = epoch, y = epoch.sec, group = run, color=run)) +
    geom_line() +
    facet_grid(cols = vars(exp), scales = scl,
                labeller = labeller(exp = lbl.exp)) +
    ## facet_grid(rows = vars(exp), scales = scl,
    ##            labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Epoch number", breaks = seq(0,10,1)) +
    scale_y_continuous(name = "Epoch time (s)", limits = c(0,NA)) +
    scale_color_discrete(name = "Run")
}

epoch.dt %>%
  filter(batch.size == 1) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times.cols(scl = "fixed") +
  theme_bw() +
  theme(legend.position = "top")

#+end_src

#+RESULTS:
[[file:./img/epoch-times-columns.png]]



Without the first epoch:

#+begin_src R :results output graphics file :file epoch-times-columns-no-first-epoch.png :exports both :width 600 :height 200 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

epoch.dt %>%
  filter(batch.size == 1) %>%
  filter(epoch != 1) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times.cols(scl = "fixed") +
  theme_bw() +
  theme(legend.position = "top")

#+end_src

#+RESULTS:
[[file:./img/epoch-times-columns-no-first-epoch.png]]


*** Plots for BS=2

#+begin_src R :results output graphics file :file epoch-times-bs2.png :exports both :width 600 :height 400 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

plot.epoch.times <- function(dt, scl="fixed")
{
  dt %>%
    ggplot(aes(x = epoch, y = epoch.sec, group = run, color=run)) +
    geom_line() +
    ## facet_grid(cols = vars(exp), scales = scl,
    ##            labeller = labeller(exp = lbl.exp)) +
    facet_grid(rows = vars(exp), scales = scl,
               labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Epoch number", breaks = seq(0,10,1)) +
    scale_y_continuous(name = "Epoch time (s)", limits = c(0,NA)) +
    scale_color_discrete(name = "Run")
}

epoch.dt %>%
  filter(batch.size == 2) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times(scl = "fixed") +
  theme_bw()

#+end_src

#+RESULTS:
[[file:./img/epoch-times-bs2.png]]

#+begin_src R :results output graphics file :file epoch-times-free-scale-bs2.png :exports both :width 600 :height 400 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

epoch.dt %>%
  filter(batch.size == 2) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times(scl = "free") +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/epoch-times-free-scale-bs2.png]]

#+begin_src R :results output graphics file :file epoch-times-no-first-epoch-bs2.png :exports both :width 600 :height 400 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

epoch.dt %>%
  filter(batch.size == 2) %>%
  filter(epoch != 1) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times(scl = "fixed") +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/epoch-times-no-first-epoch-bs2.png]]

#+begin_src R :results output graphics file :file epoch-times-no-first-epoch-free-scale-bs2.png :exports both :width 600 :height 400 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")


epoch.dt %>%
  filter(batch.size == 2) %>%
  filter(epoch != 1) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times(scl = "free") +
  theme_bw()
#+end_src

#+RESULTS:
[[file:./img/epoch-times-no-first-epoch-free-scale-bs2.png]]

**** With horizontal facets (one plot per column)

All epochs:

#+begin_src R :results output graphics file :file epoch-times-columns-bs2.png :exports both :width 450 :height 300 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

plot.epoch.times.cols <- function(dt, scl="fixed")
{
  dt %>%
    ggplot(aes(x = epoch, y = epoch.sec, group = run, color=run)) +
    geom_line() +
    facet_grid(cols = vars(exp), scales = scl,
                labeller = labeller(exp = lbl.exp)) +
    ## facet_grid(rows = vars(exp), scales = scl,
    ##            labeller = labeller(exp = lbl.exp)) +
    scale_x_continuous(name = "Epoch number", breaks = seq(0,10,1)) +
    scale_y_continuous(name = "Epoch time (s)", limits = c(0,NA)) +
    scale_color_discrete(name = "Run")
}

epoch.dt %>%
  filter(batch.size == 2) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times.cols(scl = "fixed") +
  theme_bw() +
  theme(legend.position = "top")

#+end_src

#+RESULTS:
[[file:./img/epoch-times-columns-bs2.png]]



Without the first epoch:

#+begin_src R :results output graphics file :file epoch-times-columns-no-first-epoch-bs2.png :exports both :width 450 :height 300 :noweb no-export

<<read-epoch-times>>

lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

epoch.dt %>%
  filter(batch.size == 2) %>%
  filter(epoch != 1) %>%
  mutate(run = factor(run)) %>%
  plot.epoch.times.cols(scl = "fixed") +
  theme_bw() +
  theme(legend.position = "top")

#+end_src

#+RESULTS:
[[file:./img/epoch-times-columns-no-first-epoch-bs2.png]]

** Total training times
*** Reading the data

#+name: read-training-times
#+begin_src R :results output :exports both :noweb no-export
<<fun-conv-timings>>

<<read-csv-data>>
exp.list <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

train.dt %>%
  data.frame %>%
  filter(exp %in% exp.list) %>%
  mutate(train.sec = unlist(lapply(as.character(duration), my.tsec))
         ) -> train.dt

train.dt
#+end_src

#+RESULTS: read-training-times
#+begin_example
                        exp batch.size run duration train.sec
1          IAAS-g4dn.xlarge          1   1 00:07:49       469
2          IAAS-g4dn.xlarge          1   2 00:07:28       448
3          IAAS-g4dn.xlarge          1   3 00:07:24       444
4            IAAS-p2.xlarge          1   1 00:19:14      1154
5            IAAS-p2.xlarge          1   2 00:19:14      1154
6            IAAS-p2.xlarge          1   3 00:18:37      1117
7           IAAS-p3.2xlarge          1   1 00:04:43       283
8           IAAS-p3.2xlarge          1   2 00:04:09       249
9           IAAS-p3.2xlarge          1   3 00:04:06       246
10 SAGEMAKER-ml-g4dn-xlarge          2   1 00:04:25       265
11 SAGEMAKER-ml-g4dn-xlarge          2   2 00:04:29       269
12 SAGEMAKER-ml-g4dn-xlarge          2   3 00:04:27       267
13 SAGEMAKER-ml-g4dn-xlarge          1   1 00:05:22       322
14 SAGEMAKER-ml-g4dn-xlarge          1   2 00:05:27       327
15 SAGEMAKER-ml-g4dn-xlarge          1   3 00:05:30       330
16  SAGEMAKER-ml-p3-2xlarge          2   1 00:01:50       110
17  SAGEMAKER-ml-p3-2xlarge          2   2 00:01:55       115
18  SAGEMAKER-ml-p3-2xlarge          2   3 00:01:51       111
19  SAGEMAKER-ml-p3-2xlarge          1   1 00:01:59       119
20  SAGEMAKER-ml-p3-2xlarge          1   2 00:01:57       117
21  SAGEMAKER-ml-p3-2xlarge          1   3 00:01:56       116
#+end_example

*** Plots for BS=1

#+name: plot-train-func
#+begin_src R :results output :exports both :noweb no-export
lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

lbl.exp.1l <- c("IaaS g4dn.xlarge", "IaaS p2.xlarge", "IaaS p3.2xlarge", "SageMaker ml.g4dn.xlarge", "SageMaker ml.p3.2xlarge")
names(lbl.exp.1l) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

plot.train.times <- function(dt, scl = "fixed")
{
  dt %>%
    ggplot(aes(x = run, y = train.sec, color = exp)) +
    geom_line() +
    scale_x_continuous(name = "Executions", breaks = seq(0,10,1)) +
    scale_y_continuous(name = "Training time (s)", limits = c(0,NA)) +
    scale_color_discrete(name = "Environment", labels = lbl.exp.1l)  +
    guides(color = guide_legend(nrow=3), byrow=FALSE) +
    theme_bw() +
    theme(legend.position = "top")
}

plot.train.times.col <- function(dt, scl = "fixed")
{
  dt %>%
    mutate(run = factor(run)) %>%
    ggplot(aes(x = exp, y = train.sec, fill = run)) +
    geom_col(position = position_dodge()) +
    scale_x_discrete(name = "Environment", labels = lbl.exp) +
    scale_y_continuous(name = "Training time (s)", limits = c(0,NA)) +
    scale_fill_discrete(name = "Executions") +
    theme_bw()
}

#+end_src

#+RESULTS: plot-train-func


#+begin_src R :results output graphics file :file training-times.png :exports both :width  450 :height 300 :noweb no-export

<<read-training-times>>

<<plot-train-func>>

train.dt %>%
  filter(batch.size == 1) %>%
  ## mutate(run = factor(run)) %>%
  plot.train.times(scl = "fixed") 

#+end_src

#+RESULTS:
[[file:./img/training-times.png]]


#+begin_src R :results output graphics file :file epoch-times-bars.png :exports both :width 450 :height 300 :noweb no-export

<<read-training-times>>

<<plot-train-func>>

train.dt %>%
  filter(batch.size == 1) %>%
  ## mutate(run = factor(run)) %>%
  plot.train.times.col(scl = "fixed") +
  theme(legend.position = c(0.9,0.8))

#+end_src

#+RESULTS:
[[file:./img/epoch-times-bars.png]]

*** Plots for BS=2

#+name: plot-train-func
#+begin_src R :results output :exports both :noweb no-export
lbl.exp <- c("IaaS\ng4dn.xlarge", "IaaS\np2.xlarge", "IaaS\np3.2xlarge", "SageMaker\nml.g4dn.xlarge", "SageMaker\nml.p3.2xlarge")
names(lbl.exp) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

lbl.exp.1l <- c("IaaS g4dn.xlarge", "IaaS p2.xlarge", "IaaS p3.2xlarge", "SageMaker ml.g4dn.xlarge", "SageMaker ml.p3.2xlarge")
names(lbl.exp.1l) <- c("IAAS-g4dn.xlarge", "IAAS-p2.xlarge", "IAAS-p3.2xlarge", "SAGEMAKER-ml-g4dn-xlarge", "SAGEMAKER-ml-p3-2xlarge")

plot.train.times <- function(dt, scl = "fixed")
{
  dt %>%
    ggplot(aes(x = run, y = train.sec, color = exp)) +
    geom_line() +
    scale_x_continuous(name = "Executions", breaks = seq(0,10,1)) +
    scale_y_continuous(name = "Training time (s)", limits = c(0,NA)) +
    scale_color_discrete(name = "Environment", labels = lbl.exp.1l)  +
    guides(color = guide_legend(nrow=3), byrow=FALSE) +
    theme_bw() +
    theme(legend.position = "top")
}

plot.train.times.col <- function(dt, scl = "fixed")
{
  dt %>%
    mutate(run = factor(run)) %>%
    ggplot(aes(x = exp, y = train.sec, fill = run)) +
    geom_col(position = position_dodge()) +
    scale_x_discrete(name = "Environment", labels = lbl.exp) +
    scale_y_continuous(name = "Training time (s)", limits = c(0,NA)) +
    scale_fill_discrete(name = "Executions") +
    theme_bw()
}

#+end_src

#+RESULTS: plot-train-func


#+begin_src R :results output graphics file :file training-times-bs2.png :exports both :width  450 :height 300 :noweb no-export

<<read-training-times>>

<<plot-train-func>>

train.dt %>%
  filter(batch.size == 2) %>%
  ## mutate(run = factor(run)) %>%
  plot.train.times(scl = "fixed") 

#+end_src

#+RESULTS:
[[file:./img/training-times-bs2.png]]


#+begin_src R :results output graphics file :file epoch-times-bars-bs2.png :exports both :width 450 :height 300 :noweb no-export

<<read-training-times>>

<<plot-train-func>>

train.dt %>%
  filter(batch.size == 2) %>%
  ## mutate(run = factor(run)) %>%
  plot.train.times.col(scl = "fixed") +
  theme(legend.position = c(0.9,0.8))

#+end_src

#+RESULTS:
[[file:./img/epoch-times-bars-bs2.png]]

** Billed time and costs

*** Reading the data

#+name: read-billing-data
#+begin_src R :results output :exports both :noweb no-export
<<do-init>>

temp.dt <- read.table("logs/summary.csv", sep = ",", header = TRUE,
                         stringsAsFactors = TRUE)

temp.dt %>%
  rename(price = pricing,
         boot.t = boot.time.in.seconds,
         train.t = training.time.in.seconds,
         total.t = total.time.in.seconds) %>%
  group_by(instance, type, batch.size) %>%
  mutate(run = row_number()) %>% ungroup() %>%
mutate(cost = total.t / 60 * price          
         ) -> bill.dt
bill.dt
#+end_src

#+RESULTS: read-billing-data
#+begin_example
# A tibble: 21 × 10
   instance       type   region price batch…¹ boot.t train.t total.t   run  cost
   <fct>          <fct>  <fct>  <dbl>   <int>  <int>   <int>   <int> <int> <dbl>
 1 g4dn.xlarge    IaaS   us-ea… 0.526       1    474     469     943     1  8.27
 2 g4dn.xlarge    IaaS   us-ea… 0.526       1    474     448     922     2  8.08
 3 g4dn.xlarge    IaaS   us-ea… 0.526       1    474     444     918     3  8.05
 4 p3.2xlarge     IaaS   us-ea… 3.06        1    449     283     732     1 37.3 
 5 p3.2xlarge     IaaS   us-ea… 3.06        1    449     249     698     2 35.6 
 6 p3.2xlarge     IaaS   us-ea… 3.06        1    449     246     695     3 35.4 
 7 p2.xlarge      IaaS   us-ea… 0.9         1    608    1117    1725     1 25.9 
 8 p2.xlarge      IaaS   us-ea… 0.9         1    398    1154    1552     2 23.3 
 9 p2.xlarge      IaaS   us-ea… 0.9         1    436    1117    1553     3 23.3 
10 ml.g4dn.xlarge SageM… us-ea… 0.736       2    248     265     513     1  6.29
# … with 11 more rows, and abbreviated variable name ¹​batch.size
# ℹ Use `print(n = ...)` to see more rows
#+end_example


*** Plotting the billed times for both BS=1 and BS=2

#+begin_src R :results output graphics file :file billed-times.png :exports both :width 600 :height 300 :noweb no-export

<<read-billing-data>>

plot.bill.times <- function(dt)
{
  dt %>%
    mutate(run = factor(run),
           type.inst = paste0(type, "\nbatch size = ", batch.size, "\n", instance)) %>%
    ggplot(aes(x = type.inst)) +
    geom_col(aes(y = total.t, fill = run, group = run),
             position = position_dodge2(padding = 0.3)) +
    geom_col(aes(y = train.t, fill = run, group = run),
             position = position_dodge()) + 
    scale_fill_discrete(name = "Run") +
    scale_x_discrete(name = "Instance type") +
    scale_y_continuous(name = "Training time and Billable time (s)") +
    theme_bw()
}

bill.dt %>%
  plot.bill.times()

#+end_src

#+RESULTS:
[[file:./img/billed-times.png]]

*** Training time relative to the total billed time  for both BS=1 and BS=2

#+begin_src R :results output graphics file :file training-rel-billed-times.png :exports both :width 600 :height 300 :noweb no-export

<<read-billing-data>>

plot.rel.train.times <- function(dt)
{
  dt %>%
    mutate(run = factor(run),
           rel.train.t = train.t / total.t, 
           type.inst = paste0(type, "\nbatch size = ", batch.size, "\n", instance)) %>%
    ggplot(aes(x = type.inst)) +
    geom_col(aes(y = rel.train.t, fill = run, group = run),
             position = position_dodge()) +
        scale_fill_discrete(name = "Run") +
    scale_x_discrete(name = "Instance type") +
    scale_y_continuous(name = "Proportion of the billable time spent on training") +
    theme_bw()
}

bill.dt %>%
  plot.rel.train.times()

#+end_src

#+RESULTS:
[[file:./img/training-rel-billed-times.png]]


*** Plotting the total costs for both BS=1 and BS=2

#+begin_src R :results output graphics file :file total-costs.png :exports both :width 600 :height 300 :noweb no-export

<<read-billing-data>>

plot.costs <- function(dt)
{
  dt %>%
    mutate(run = factor(run),
           type.inst = paste0(type, "\nbatch size = ", batch.size, "\n", instance)) %>%
    ggplot(aes(x = type.inst, y = cost, fill = run)) +
    geom_col(position = position_dodge()) +
    scale_fill_discrete(name = "Run") +
    scale_x_discrete(name = "Instance type") +
    scale_y_continuous(name = "Total cost (USD)") +
    theme_bw()
}

bill.dt %>%
  plot.costs()

#+end_src

#+RESULTS:
[[file:./img/total-costs.png]]

*** Stacked bars with errorbars
**** Reading the data

#+name: read-billing-data-v2
#+begin_src R :results output :exports both :noweb no-export
<<do-init>>

temp.dt <- read.table("logs/summary.csv", sep = ",", header = TRUE,
                         stringsAsFactors = TRUE)

temp.dt %>%
  rename(price = pricing,
         boot.t = boot.time.in.seconds,
         train.t = training.time.in.seconds,
         total.t = total.time.in.seconds) %>%
  mutate(rem.t = total.t - boot.t - train.t,
         total.c = total.t * price / 3600,
         boot.c = boot.t * price / 3600,
         train.c = train.t * price / 3600,
         rem.c = rem.t * price / 3600) %>%
  data.frame() -> bill.dt

## head(bill.dt)
#+end_src

#+RESULTS: read-billing-data-v2
#+begin_example
     instance type    region price batch.size boot.t train.t total.t rem.t
1 g4dn.xlarge IaaS us-east-1 0.526          1    474     469     943     0
2 g4dn.xlarge IaaS us-east-1 0.526          1    474     448     922     0
3 g4dn.xlarge IaaS us-east-1 0.526          1    474     444     918     0
4  p3.2xlarge IaaS us-east-1 3.060          1    449     283     732     0
5  p3.2xlarge IaaS us-east-1 3.060          1    449     249     698     0
6  p3.2xlarge IaaS us-east-1 3.060          1    449     246     695     0
    total.c     boot.c    train.c rem.c
1 0.1377828 0.06925667 0.06852611     0
2 0.1347144 0.06925667 0.06545778     0
3 0.1341300 0.06925667 0.06487333     0
4 0.6222000 0.38165000 0.24055000     0
5 0.5933000 0.38165000 0.21165000     0
6 0.5907500 0.38165000 0.20910000     0
#+end_example

It seems that the total time is always the sum of the training time and the boot
time. But I'll take a look at the logs to make sure the data in the table is
correct.

#+name: prepare-billing-data
#+begin_src R :results output :exports both :noweb no-export
<<read-billing-data-v2>>

bill.dt %>%
  group_by(instance, type, batch.size) %>%
  summarize(med = median(total.c),
            min = min(total.c),
            max = max(total.c)) %>%
  ungroup() %>%
  mutate(metric = "Total cost") %>% data.frame -> total.c

bill.dt %>%
  group_by(instance, type, batch.size) %>%
  summarize(med = median(boot.c),
            min = min(boot.c),
            max = max(boot.c)) %>%
  ungroup() %>%
  mutate(metric = "Boot cost")  %>% data.frame -> boot.c

bill.dt %>%
  group_by(instance, type, batch.size) %>%
  summarize(med = median(train.c),
            min = min(train.c),
            max = max(train.c)) %>%
  ungroup() %>%
  mutate(metric = "Training cost") %>% data.frame  -> train.c

bill.dt %>%
  group_by(instance, type, batch.size) %>%
  summarize(med = median(rem.c),
            min = min(rem.c),
            max = max(rem.c)) %>%
  ungroup() %>%
  mutate(metric = "Remaining cost") %>% data.frame  -> rem.c


costs <- rbind(boot.c, train.c, rem.c, total.c)
costs$metric <- factor(costs$metric, levels = c("Training cost", "Boot cost", "Remaining cost", "Total cost"))

glimpse(costs)
#+end_src

#+RESULTS: prepare-billing-data
: Rows: 28
: Columns: 7
: $ instance   <fct> g4dn.xlarge, ml.g4dn.xlarge, ml.g4dn.xlarge, ml.p3.2xlarge,…
: $ type       <fct> IaaS, SageMaker, SageMaker, SageMaker, SageMaker, IaaS, Iaa…
: $ batch.size <int> 1, 1, 2, 1, 2, 1, 1, 1, 1, 2, 1, 2, 1, 1, 1, 1, 2, 1, 2, 1,…
: $ med        <dbl> 0.06925667, 0.04784000, 0.05070222, 0.23800000, 0.25287500,…
: $ min        <dbl> 0.06925667, 0.04620444, 0.05070222, 0.23162500, 0.24225000,…
: $ max        <dbl> 0.06925667, 0.04947556, 0.05111111, 0.25075000, 0.30281250,…
: $ metric     <fct> Boot cost, Boot cost, Boot cost, Boot cost, Boot cost, Boot…



**** Plotting

#+name: plot-costs-stacked
#+begin_src R :results output graphics file :file costs-stacked.png :exports both :width 800 :height 400 :noweb no-export

<<prepare-billing-data>>

plot.costs <- function(dt)
{
  dt %>%
    mutate(type.inst = paste0(type, "\nbatch size = ", batch.size, "\n", instance)) %>%
    ggplot(aes(x = type.inst, y = med, ymin = min, ymax = max, fill = metric)) +
    geom_col() +
    geom_errorbar(width = 0.25) +
    ## geom_point() +
    geom_point(aes(y = medsum), show.legend = FALSE) +
    scale_fill_discrete(name = "") +
    scale_x_discrete(name = "Configuration") +
    scale_y_continuous(name = "Costs (USD)") +
    theme_bw() +
    theme(text = element_text(size = 10, family = "serif"),
          plot.margin = margin(1, 1, 1, 1, "pt"),
          legend.position = c(0.85, 0.85),
          legend.text = element_text(size = 14)
          )
}

## As the error bars can't be stacked, I'll have to adjust the training
## cost to account for the stacking:
costs$min[costs$metric == "Training cost"] <-
  costs$min[costs$metric == "Training cost"] +
  costs$med[costs$metric == "Boot cost"]

costs$max[costs$metric == "Training cost"] <-
  costs$max[costs$metric == "Training cost"] +
  costs$med[costs$metric == "Boot cost"] 

costs$medsum[costs$metric == "Training cost"] <-
  costs$med[costs$metric == "Training cost"] +
  costs$med[costs$metric == "Boot cost"]
costs$medsum[costs$metric == "Boot cost"] <-
  costs$med[costs$metric == "Boot cost"]

## Now we call the plot function.
costs %>%
  filter(metric %in% c("Boot cost", "Training cost")) %>%
  plot.costs()

#+end_src

#+RESULTS: plot-costs-stacked
[[file:./img/costs-stacked.png]]


#+name: plot-costs-stacked-pdf
#+begin_src R :results output graphics file :file costs-stacked.pdf :exports both :width 8 :height 4 :noweb no-export

<<plot-costs-stacked>>

#+end_src

#+RESULTS: plot-costs-stacked-pdf
[[file:./img/costs-stacked.pdf]]



* Scratchpad


#+begin_src R :results output :exports both :noweb no-export
iter.dt %>% filter(epoch==1 & iter==1) %>% select(exp, run, epoch, iter, iter.elapsed, iter.dur)
#+end_src

#+RESULTS:
#+begin_example
                     exp run epoch iter iter.elapsed  iter.dur
1       IAAS-g4dn.xlarge   1     1    1      125.117   125.117
2       IAAS-g4dn.xlarge   2     1    1      125.065  -343.775
3       IAAS-g4dn.xlarge   3     1    1      125.086  -322.650
4         IAAS-p2.xlarge   1     1    1      181.529  -262.185
5         IAAS-p2.xlarge   2     1    1      148.514 -1005.516
6         IAAS-p2.xlarge   3     1    1      188.090  -966.375
7  SAGEMAKER-g4dn-xlarge   1     1    1        9.497 -1107.282
8  SAGEMAKER-g4dn-xlarge   2     1    1        8.680  -255.928
9  SAGEMAKER-g4dn-xlarge   3     1    1        8.850  -259.802
10  SAGEMAKER-p3-2xlarge   1     1    1        6.290  -260.866
11  SAGEMAKER-p3-2xlarge   2     1    1       10.952   -99.409
12  SAGEMAKER-p3-2xlarge   3     1    1        7.507  -107.943
#+end_example

#+begin_src R :results output :exports both :noweb no-export
iter.dt %>% filter(epoch==1 & iter==1) %>% select(exp, run, epoch, iter, iter.elapsed, iter.dur)
#+end_src

#+RESULTS:
#+begin_example
# A tibble: 15 × 6
   exp                        run epoch  iter iter.elapsed iter.dur
   <fct>                    <int> <int> <int>        <dbl>    <dbl>
 1 IAAS-g4dn.xlarge             1     1     1       125.     125.  
 2 IAAS-g4dn.xlarge             2     1     1       125.     125.  
 3 IAAS-g4dn.xlarge             3     1     1       125.     125.  
 4 IAAS-p2.xlarge               1     1     1       182.     182.  
 5 IAAS-p2.xlarge               2     1     1       149.     149.  
 6 IAAS-p2.xlarge               3     1     1       188.     188.  
 7 IAAS-p3.2xlarge              1     1     1       174.     174.  
 8 IAAS-p3.2xlarge              2     1     1       137.     137.  
 9 IAAS-p3.2xlarge              3     1     1       136.     136.  
10 SAGEMAKER-ml-g4dn-xlarge     1     1     1         9.50     9.50
11 SAGEMAKER-ml-g4dn-xlarge     2     1     1         8.68     8.68
12 SAGEMAKER-ml-g4dn-xlarge     3     1     1         8.85     8.85
13 SAGEMAKER-ml-p3-2xlarge      1     1     1         6.29     6.29
14 SAGEMAKER-ml-p3-2xlarge      2     1     1        11.0     11.0 
15 SAGEMAKER-ml-p3-2xlarge      3     1     1         7.51     7.51
#+end_example

#+begin_src R :results output :exports both :noweb no-export
lbl.exp
#+end_src

#+RESULTS:
:           IaaS g4dn.xlarge             IaaS p2.xlarge 
:         "IAAS-g4dn.xlarge"           "IAAS-p2.xlarge" 
:            IaaS p3.2xlarge   SageMaker ml.g4dn.xlarge 
:          "IAAS-p3.2xlarge" "SAGEMAKER-ml-g4dn-xlarge" 
:    SageMaker ml.p3.2xlarge 
:  "SAGEMAKER-ml-p3-2xlarge"


#+begin_src R :results output :exports both :noweb no-export
p = data.frame()
n = 1
for(i in unique(iter.dt$exp)){
  for(r in unique(iter.dt$run)){
    p[i,r] = n
    n = n + 1
    print(paste(i, r, p[i,r]))
  }
}

#+end_src

#+RESULTS:
#+begin_example
[1] "IAAS-g3s.xlarge 1 1"
[1] "IAAS-g3s.xlarge 2 2"
[1] "IAAS-g3s.xlarge 3 3"
[1] "IAAS-g4dn.xlarge 1 4"
[1] "IAAS-g4dn.xlarge 2 5"
[1] "IAAS-g4dn.xlarge 3 6"
[1] "IAAS-g5.xlarge 1 7"
[1] "IAAS-g5.xlarge 2 8"
[1] "IAAS-g5.xlarge 3 9"
[1] "IAAS-p2.xlarge 1 10"
[1] "IAAS-p2.xlarge 2 11"
[1] "IAAS-p2.xlarge 3 12"
[1] "IAAS-p3.2xlarge 1 13"
[1] "IAAS-p3.2xlarge 2 14"
[1] "IAAS-p3.2xlarge 3 15"
[1] "SAGEMAKER-ml-g4dn-xlarge 1 16"
[1] "SAGEMAKER-ml-g4dn-xlarge 2 17"
[1] "SAGEMAKER-ml-g4dn-xlarge 3 18"
[1] "SAGEMAKER-ml-p3-2xlarge 1 19"
[1] "SAGEMAKER-ml-p3-2xlarge 2 20"
[1] "SAGEMAKER-ml-p3-2xlarge 3 21"
#+end_example

#+begin_src R :results output :exports both :noweb no-export
iter.dt %>%
  filter(batch.size == 1) %>%
  mutate(epoch = factor(epoch)) %>%
  select(exp, run, epoch, iter, iter.dur) %>%
  filter( run == 2 & exp == "SAGEMAKER-ml-g4dn-xlarge") %>%
  filter(!(epoch == 1 & iter == 1)) %>%
  data.frame() -> dt.tmp

max(dt.tmp$iter.dur)
#+end_src

#+RESULTS:
: [1] 2.473

#+begin_src R :results output :exports both :noweb no-export
lbl.exp["SAGEMAKER-ml-g4dn-xlarge"]
#+end_src

#+RESULTS:
:    SAGEMAKER-ml-g4dn-xlarge 
: "SageMaker\nml.g4dn.xlarge"
